<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Step 3: Generate file descriptions</title>
<link rel="stylesheet" type="text/css" href="../../../../remark_files/remark.css" />
<link rel="stylesheet" type="text/css" href="../../../../remark_files/pygments.css" />

</head>
<body>
<div id = "remark-all">
<div id = "remark">
<div class = "ParentList">

<ol>
<li><a href="somsds.htm">SOMSDS</a></li>
<li><a href="user_documentation.htm">User Documentation</a></li>
<li><a href="howto_recordings.htm">Organizing experimental data</a></li>
<li><a href="howto_file_descriptions.htm">Step 3: Generate file descriptions</a></li>
</ol>
</div>

<div class = "remark-end-list"></div>

<h1>Step 3: Generate file descriptions</h1>
<p><a href="howto_recordings.htm">Back to Organizing experimental data</a></p>
<p>The SOMSDS scripts can automatically generate symbolic links with suitable names
to the most relevant data files in a recording. However, for the scripts to 
be able to do that, they need to know two pieces of information:</p>
<ul>
<li>The sub-set of experimental files that are deemed relevant enough to be 
worth linking to.</li>
<li>The subject ID, modality ID, condition ID, etc. corresponding to each of these
relevant data files.</li>
</ul>
<p>The former is needed because the set of data files that are to be used in 
everyday analyses is usually much smaller that the actual set of files acquired
during a recording session. The latter is required in order to generate symbolic
links with standard names, as described in <a href="./ds.htm">The SOMSDS Data Structure</a></p>
<h2>File name translation</h2>
<p>In the <a href="./howto_dirtree.htm">previous step</a> we placed our files in folders like:</p>
<pre><code>/data/recordings/bcgs/subjects/$SUBJID/$MODID/orig/$CONDID/
</code></pre>
<p>Thanks to that, the SOMSDS scripts can easily guess the subject, 
modality and condition IDs of all your data files, as this information is simply
encoded in the location of each file. </p>
<p>Guessing the block ID of a given file is not that straightforward, as different 
researchers, or different recording devices, may use different ways to encode
this information in a file name. For instance, see how the researcher that 
acquired the <code>bcgs</code> data named the EEG files for subject <code>0002</code>:</p>
<pre><code>.../0002/eeg/orig/out/outside_JM_run1.mff 
.../0002/eeg/orig/out/outside_JM_run2.mff 
.../0002/eeg/orig/out/outside_JM_run3.mff 
.../0002/eeg/orig/out/outside_JM_run4.mff

.../0002/eeg/orig/in-noscan/inside_noscan_JM_run1.mff
.../0002/eeg/orig/in-noscan/inside_noscan_JM_run2.mff
.../0002/eeg/orig/in-noscan/inside_noscan_JM_run3.mff
.../0002/eeg/orig/in-noscan/inside_noscan_JM_run4.mff

.../0002/eeg/orig/in-scan/inside_noscan_JM_run1.mff
.../0002/eeg/orig/in-scan/inside_noscan_JM_run2.mff
.../0002/eeg/orig/in-scan/inside_noscan_JM_run3.mff
.../0002/eeg/orig/in-scan/inside_noscan_JM_run4.mff
</code></pre>
<p>Clearly the number after the text <code>run</code> is the block number of a given EEG file.
On the other hand, modality <code>smri</code> consists of files with names like:</p>
<pre><code>.../smri/orig/ger001_WIP_c32_cap_B0_SENSE_FSL_8_1.nii
.../smri/orig/ger001_WIP_c32_cap_T1_SENSE_FSL_9_1.nii
...
... etc
</code></pre>
<p>and in this case we would like to be able to guess the MRI scanning 
technique, i.e. whether the scan is a T1 or a B1 scan. Finally, for the <code>fmri</code>
 modality we have files like the ones below:</p>
<pre><code>.../fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_3_1.nii
.../fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_4_1.nii
.../fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_5_1.nii
.../fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_7_1.nii
</code></pre>
<p>In this last case, the SOMSDS scripts should be able to realize that each of
the files above is just a different scanning block: <code>3_1</code>, <code>4_1</code>, <code>5_1</code>, <code>7_1</code>. 
Note that, in this recording, the term <em>block</em> has a different meaning for EEG
 and fMRI files. </p>
<p>Most often, the naming convention used with files of a given modality can be
 compactly expressed using a so-called <em>translation file</em>. Below we describe 
how to write such translation files for recording <code>bcgs</code>.</p>
<h3>Modality eeg</h3>
<p>For the EEG modality 
the <code>bcgs_eeg-translation.ini</code> translation file looks like this:</p>
<pre><code># Translation file for the EEG modality of recording bcgs

# This line is a comment

[block_id]
# The regular expression below translate a file name to a block ID

regexp="s%^.+run(\d).*$%$1%"

[file_id]
# The regular expression below matches all files to which a symbolic link
# should be generated. In our case, we only want links to be generated to 
# files/directories ending in .mff

regexp =".mff$"
</code></pre>
<p>If you don't know what a <a href="http://en.wikipedia.org/wiki/Regular_expression">regular expression</a> is, you will have to ask
 <a href="mailto:g.gomez@nin.knaw.nl">someone who knows</a> to write the <em>translation file</em>
for you. You will have to write such a file only once, provided of course that
you don't change the  way you name your files in the future. That is, if we
acquire more <code>bcgs</code> subjects in the future you should use file names containing
the string <code>runD</code> (with <code>D</code> a number) to tell the block number of the file. </p>
<h3>Modality smri</h3>
<p>For the structural MRI modality of the <code>bcgs</code> recording, the translation file 
<code>bcgs_translation-smri.ini</code> looks like this:</p>
<pre><code>[technique_id]
# Translation from file name to technique id
regexp="s%^.+(T1|B0|B1|SmartBrain).+$%$1%"

[technique_id_map]
# This section can be used to defined a mapping from the technique
# IDs picked from the file names and the actual technique IDs that
# we want to use when generating the symbolic links
T1=t1
B0=b0
B1=b1
SmartBrain=sbrain

[file_id]
# This regular expression matches all files to which links are to
# be generated. In this case we want to generate links only to
# files having an ancestor directory smri and having an extension .nii
regexp =".+/smri/.+\.nii$"
</code></pre>
<h3>Modality fmri</h3>
<p>For the functional MRI we have the file <code>bcgs_translation-fmri.ini</code>:</p>
<pre><code>[block_id]
# Translation from file name to block id
regexp="s%^.+_(\d+)_(\d+)\..+$%$1-$2%"

[file_id]
# This regular expression matches the files that will be linked
regexp =".+/fmri/.+\.nii$"
</code></pre>
<p>Once you have written your translation files, it is a good idea to place them
in the <code>doc</code> folder of your recording. For recording <code>bcgs</code> we place them under
<code>/data/recordings/bcgs/doc</code>.</p>
<h2>Generate tags for each file</h2>
<p>At this point you should run:</p>
<pre><code>somsds_describe /data/recordings/bcgs 
    --conf bcgs_translation-eeg.ini, 
           bcgs_translation-fmri.ini, 
           bcgs_translation-smri.ini
</code></pre>
<p>The command above will create (under <code>/data/recordings/bcgs</code>) a
 <em>descriptor file</em> for each input 
translation file. A descriptor file is a comma separated values (.csv) file that
specifies the values of various information tags for all files to which symbolic
links are to be generated.<br />
</p>
<h3>Descriptor file for modality smri</h3>
<p>The contents of descriptor file <code>files_bcgs-translation-smri.csv</code> 
are summarized below:</p>
<pre><code>"id","subject","modality","device","technique","condition","session","block","meta"
"subjects/0001/smri/orig/ger001_WIP_c32_cap_B1_SENSE_FSL_8_1.nii","0001","smri",,"b1",,,,,
"subjects/0001/smri/orig/ger001_WIP_SmartBrain_FSL_1_1.nii","0001","smri",,"sbrain",,,,,
"subjects/0001/smri/orig/ger001_WIP_c32_cap_T1_SENSE_FSL_9_1.nii","0001","smri",,"t1",,,,,
"subjects/0002/smri/orig/ger001_WIP_c32_cap_B0_SENSE_FSL_18_1.nii","0002","smri",,"b0",,,,,
"subjects/0002/smri/orig/ger001_WIP_c32_cap_T1_SENSE_FSL_16_1.nii","0002","smri",,"t1",,,,,
"subjects/0002/smri/orig/ger001_WIP_c32_cap_B1_SENSE_FSL_17_1.nii","0002","smri",,"b1",,,,,
</code></pre>
<h3>Descriptor file for modality fmri</h3>
<p>The contents of descriptor file <code>files_bcgs-translation-fmri.csv</code> are:</p>
<pre><code>"id","subject","modality","device","technique","condition","session","block","meta"
"subjects/0001/fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_4_1.nii","0001","fmri",,,,,"4-1",,
"subjects/0001/fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_5_1.nii","0001","fmri",,,,,"5-1",,
"subjects/0001/fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_3_1.nii","0001","fmri",,,,,"3-1",,
"subjects/0001/fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_7_1.nii","0001","fmri",,,,,"7-1",,
"subjects/0002/fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_12_1.nii","0002","fmri",,,,,"12-1",,
"subjects/0002/fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_14_1.nii","0002","fmri",,,,,"14-1",,
"subjects/0002/fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_15_1.nii","0002","fmri",,,,,"15-1",,
"subjects/0002/fmri/orig/ger001_WIP_c32_cap_check_SENSE_FSL_13_1.nii","0002","fmri",,,,,"13-1",,
</code></pre>
<h3>Descriptor file for modality eeg</h3>
<p>The contents of <code>files_bcgs-translation-eeg.csv</code> look like:</p>
<pre><code>"id","subject","modality","device","technique","condition","session","block","meta"
"subjects/0001/eeg/orig/in-scan/inside_scan_GGH_run4.mff","0001","eeg",,,"in-scan",,"4",,
"subjects/0001/eeg/orig/in-scan/inside_scan_GGH_run3.mff","0001","eeg",,,"in-scan",,"3",,
"subjects/0001/eeg/orig/in-scan/inside_scan_GGH_run1.mff","0001","eeg",,,"in-scan",,"1",,
"subjects/0001/eeg/orig/in-scan/inside_scan_GGH_run2.mff","0001","eeg",,,"in-scan",,"2",,
"subjects/0001/eeg/orig/in-noscan/inside_noscan_GGH_run3.mff","0001","eeg",,,"in-noscan",,"3",,
"subjects/0001/eeg/orig/in-noscan/inside_noscan_GGH_run1.mff","0001","eeg",,,"in-noscan",,"1",,
"subjects/0001/eeg/orig/in-noscan/inside_noscan_GGH_run2.mff","0001","eeg",,,"in-noscan",,"2",,
"subjects/0001/eeg/orig/in-noscan/inside_noscan_GGH_run4.mff","0001","eeg",,,"in-noscan",,"4",,
"subjects/0001/eeg/orig/out/outside_GGH_run4.mff","0001","eeg",,,"out",,"4",,
"subjects/0001/eeg/orig/out/outside_GGH_run3.mff","0001","eeg",,,"out",,"3",,
"subjects/0001/eeg/orig/out/outside_GGH_run1.mff","0001","eeg",,,"out",,"1",,
... FILES FOR SUBJECT 0002 ARE OMITTED
</code></pre>
<p>It is important that you inspect the generated descriptor files to ensure that 
the tags have been properly identified and that all the relevant files are there.
Remember that <strong>only the files that appear in at least one of the descriptor files
will be linked to</strong>.</p>
<p><strong>NOTE:</strong> Instead of using script <code>somsds_describe</code> to generate the files above,
you could also write them yourself, either manually or using your own scripts.
 In this case, it is important that you name your <em>descriptor file(s)</em> like
 <code>files[anything].csv</code>, where <code>[anything]</code> can be any text. Moreover, you should
ensure that the internal format of your .csv files is identical to the format 
of the examples above. For instance, <strong>you should not have any spurious spaces 
before or after the separation commas</strong>. </p>
<h2>Hint</h2>
<p>Sometimes script <code>somsds_describe</code> outputs so much information to the screen 
that it is difficult (or impossible) to know whether any warnings were generated.
In such cases you can redirect the standard output of <code>somsds_describe</code> to a 
text file so that only warnings will be displayed. That is, you could run:</p>
<pre><code>somsds_describe /data/recordings/bcgs 
    --conf bcgs_translation-eeg.ini, 
           bcgs_translation-fmri.ini, 
           bcgs_translation-smri.ini &gt; output.txt
</code></pre>
<h2>What now?</h2>
<p>We are now ready to go to the <a href="./howto_make_links.htm">next step</a>, that is to
generate the symbolic links with the standard naming convention discussed in 
<a href="./ds.htm">The SOMSDS data structure</a></p>
</div>
<div id="remark-footer">
<p><a href="http://kaba.hilvi.org/remark">Remark 1.5.1</a> - Page generated 16.10.2012 17:08.</p>
</div>
</div>
</body>
</html>
