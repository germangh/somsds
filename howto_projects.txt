Perform analyses
============

[[Parent]]: user_documentation.txt

When analyzing data, the first thing that you need to do is to generate a 
_project_ directory where to store your scripts, documents, and intermediate
and final results. To illustrate the process, we will follow on the `bcgs` 
recording that we discussed in [Organizing your experimental data][recordings].

[recordings]: ./howto_recordings.htm


## Generate a project folder

To generate a _project_ directory containing a set of standard sub-folders run:

	somsds_new_project bcgs gherrero,yvdmeer,jramautar

The first argument to script `somsds_new_project` is the ID of your project. 
Since this project is going to involve the analysis of a single recording, it is 
reasonable to use the same ID for the project and the recording. The second
argument is a comma separate list of valid usernames. The first user in this 
list will be considered the responsible of the project and as such he or she 
will be the owner of the project directories. The other users in this list will
 all become members of a user group called `bcgs`, which will be granted write 
permission on the project folders. If more people become involved in the future
they should be manually added to the `bcgs` group.

Creating user groups and adding users to new groups can only be done by a
system administrator. This means that you __should ask an admin to generate your 
project directory tree__.

## Default directories

The default project directory tree consists of the following sub-directories:

	/data/projects/bcgs/tmp
	/data/projects/bcgs/doc
	/data/projects/bcgs/recordings
	/data/projects/bcgs/scripts
	/data/projects/bcgs/analysis
	/data/projects/bcgs/results/articles
	/data/projects/bcgs/results/posters
	/data/projects/bcgs/results/presentations	
	/data/projects/bcgs/results/software

### The `tmp` folder

The `tmp` folder should be used to store truly temporary data, i.e. after 
finalizing a project you should be able to empty the `tmp` folder without
 risking loosing any relevant data.

### The `doc` folder 

In the `doc` folder you should store all the documents required for understanding
your experimental protocol. The [recording settings file][settings_file] and
 all the relevant [name translation files][translation_file] should also be
 located here. 

[settings_file]: ./howto_settings_file.htm
[translation_file]: ./howto_file_descriptions.htm

### The `recordings` folder

The `recordings` folder will typically contain symbolic links to the data files
 that are being used by the project. Below we describe how this links can be
 generated. It might be a good idea to keep also in this recording single 
subject analyses and pre-processed files, but this is up to you. 

### The `scripts` folder

The `scripts` folder contains all the scripts necessary for reproducing all the
 analyses performed during the project. This folder should also contain a copy
 of all the toolboxes that were used in the project. This is important in order
 to ensure that the analyses can be reproduced in the future, even if the 
relevant toolboxes have changed due to continued development. 

### The `analysis` folder

The results and intermediate steps of your analysis should be stored in the
 `analysis` folder. 

### The `results` folder

The `results` folder should contain only publishable (well documented) outcomes
 of the project. This includes posters, papers, presentations and also any piece
 of software developed during the project and that might be publicly released.

## Link to recording data

### Link to /data/recordings/bcgs/subjects

The easiest (but not the recommended) way to work with your data is to simply
 create a symbolic link to `/data/recordings/bcgs/subjects`. This is done with
 the command:

	ln -s /data/recordings/bcgs/subjects 
		/data/projects/bcgs/recordings/svui/subjects

Where the first input path to `ln -s` is the target path (the data you want to 
link to) and the second input path is the name that you want to give to your 
link. 

### Use somsds_link2rec

A more flexible alternative for generating symbolic links to the data relevant 
to the `bcgs` project is to go to the `/data/projects/bcgs/recordings` folder 
and run:

	somsds_link2rec bcgs --modalities eeg,smri
	
which will create links to all EEG and structural MRI data files of
recording `bcgs`. You can also specify a sub-set of subjects, techniques, etc 
using the correponding options `--subjects`, `--techniques`, etc. If you want to
link to all files from recording `bcgs`, you can run script `somsds_link2rec` 
without any option. The command above will create all the links in folder 
`bcgs`:

	
	[gherrero@somerenserver recordings]$ ls bcgs
	bcgs_0001_eeg_in-noscan_1.mff  bcgs_0002_eeg_in-noscan_1.mff
	bcgs_0001_eeg_in-noscan_2.mff  bcgs_0002_eeg_in-noscan_2.mff
	bcgs_0001_eeg_in-noscan_3.mff  bcgs_0002_eeg_in-noscan_3.mff
	bcgs_0001_eeg_in-noscan_4.mff  bcgs_0002_eeg_in-noscan_4.mff
	bcgs_0001_eeg_in-scan_1.mff    bcgs_0002_eeg_in-scan_1.mff
	bcgs_0001_eeg_in-scan_2.mff    bcgs_0002_eeg_in-scan_2.mff
	bcgs_0001_eeg_in-scan_3.mff    bcgs_0002_eeg_in-scan_3.mff
	bcgs_0001_eeg_in-scan_4.mff    bcgs_0002_eeg_in-scan_4.mff
	bcgs_0001_eeg_out_1.mff        bcgs_0002_eeg_out_1.mff
	bcgs_0001_eeg_out_2.mff        bcgs_0002_eeg_out_2.mff
	bcgs_0001_eeg_out_3.mff        bcgs_0002_eeg_out_3.mff
	bcgs_0001_eeg_out_4.mff        bcgs_0002_eeg_out_4.mff
	bcgs_0001_smri_b1.nii          bcgs_0002_smri_b0.nii
	bcgs_0001_smri_sbrain.nii      bcgs_0002_smri_b1.nii
	bcgs_0001_smri_t1.nii          bcgs_0002_smri_t1.nii	

Now you can use the symbolic links above to perform any analysis that you may
think of. In most aspects these symbolic links can be understood as
nicely renamed copies of the original data files.

You may prefer the links to be organized in the same way as in 
`/data/recordings/bcgs`, instead of having them all under the same folder. 
For that you can use the flag `--orig`:

	somsds_link2rec bcgs --modalities eeg,smri --orig

which will create the folder structure:

	/data/projects/bcgs/recordings/bcgs/subjects/0001/eeg/raw/*.mff
 	/data/projects/bcgs/recordings/bcgs/subjects/0001/smri/raw/*.nii
	/data/projects/bcgs/recordings/bcgs/subjects/0001/eeg/raw/*.mff
 	/data/projects/bcgs/recordings/bcgs/subjects/0001/smri/raw/*.nii

The organization above is especially handy if you are planning to use software 
packages that use a similar folder structure (e.g. [FreeSurfer][freesurfer] or
the [MNE software][mne]). 

[freesurfer]: http://surfer.nmr.mgh.harvard.edu/
[mne]: http://www.nmr.mgh.harvard.edu/martinos/userInfo/data/sofMNE.php


## File permissions

A common issue when multiple people work on the same project is the fact that
files created by one user cannot be read by another user working on the same
project. For instance consider the case that `gherrero` creates a file 
in directory `/data/projects/bcgs/scripts/test.m`. By default file `test.m`
will be owned by the __primary group__ of user `gherrero` which is not 
necessarily `bcgs`. Note that a user can belong to multiple groups. As a 
result `test.m` will not be executable by user `jramautar`, even though
both `jramautar` and `gherrero` belong to the group `bcgs`. The solution to
this undesired behavior is to run the following command every time you open
 a command shell window:

	newgrp bcgs

The command above will temporarily change the primary group of `gherrero` 
(the currently user of the shell window) to `bcgs`. Therefore, any file
 created by `gherrero` from now on will belong 
to group `bcgs` and therefore they will be fully accessible by other members
of the the `bcgs` project. Remember that you need to use command `newgrp` 
only once for each shell window. It is also important to realize that 
`newgrp` will not help you if you typically move or create files from the
graphical user interface instead of creating them from a shell window.

If you are not sure of what is your primary group and to which groups you
belong you can issue the command:

	id -G -n gherrero

where you should change `gherrero` for your username. The first group in the
list is that is displayed is your primary group.


## Pre-processing scripts

One of the great advantages of using a consistent organization of data files is 
that we can easily re-use analysis scripts. Below we show a couple of examples:

### Freesurfer

Imagine we would like to perform a [FreeSurfer][freesurfer] analysis on the 
two subjects of recording `bcgs`. You could do that by going to folder 
`/data/projects/bcgs/recordings` and running:

	somsds_link2rec bcgs --modality smri --orig
	smri_freesurfer bcgs

The simple script `smri_freesurfer` can save you some time if you have many
 subjects. Moreover, it will try to use the [Oracle Grid Engine][oge] that is 
installed in the server to run your jobs in parallel and without disturbing 
too much the work of others. 

[oge]: http://www.oracle.com/us/products/tools/oracle-grid-engine-075549.html

__NOTE:__ By default, Freesurfer generates symbolic links in the subjects 
folder to the `fsaverage`, `lh.EC_average` and `rh.EC_average` subject 
directories within the Freesurfer directory tree. This can cause troubles
if you later move folder `bcgs` to another system where the location of 
the Freesurfer installation is different. There are two possible solutions
to this problem. The first solution is to simply copy those folders rather
than linking to them:

	somsds_freesurfer bcgs --copyfsavg
	
The second alternative is to use script `somsds_fix_links` to fix the 
broken symbolic links. See below for more information on `somsds_fix_links`.


### MNE

If you aim to use the [MNE software][mne] to reconstruct the brain sources 
underlying your EEG or MEG data, you will have to perform a series of 
pre-processing steps, as described in the documentation of the MNE software. 
All these steps can now be simply performed with the commands:

	somsds_link2rec bcgs --modality smri --orig
	smri_mne bcgs

Again, `mne_bcgs` will use [Oracle Grid Engine][oge] to run these steps in 
parallel and without overloading the server. 


## Copying directory trees

Consider the case that you want to perform a Freesurfer `recon-all` analysis
of the `bcgs` dataset. Subsequently you want to run all the MNE preprocessing
steps. You could do something like this:

	somsds_link2rec bcgs --modality smri --orig
	smri_freesurfer bcgs
	smri_mne bcgs

This will result in a single folder called `bcgs` where _both_ the 
Freesurfer and MNE results are stored. However, it is much more practical to 
keep the results of Freesurfer and MNE as separate as possible so that other
people can link or copy only the folders they are truly interested in. So, 
a better way of performing these two analysis would be this:

	somsds_link2rec bcgs-freesurfer --modality smri --orig
	smri_freesurfer bcgs-freesurfer
	somsds_link2dir bcgs-freesurfer bcgs-mne
	smri_mne bcgs-mne
	
The command `somsds_link2dir bcgs-freesurfer bcgs-mne` will generate a folder
called `bcgs-mne` whose contents will be symbolic links to all the files within
folder `bcgs-freesurfer`. In this way, running `smri_mne bcgs-mne` will run
smoothly as all the MNE software will find the Freesurfer files in their 
expected locations. At the same time, we are able to keep the Freesurfer and MNE
results separate, while avoiding duplicating any data. 


## Moving/renaming directory trees

### Broken links

If you move or rename the directory trees you may break symbolic links. For 
instance, let us consider the case that we have two directory trees:

	bcgs-freesurfer
	bcgs-mne
	
The former contains only Freesurfer analyses results while the latter contains
MNE results plus symbolic links to the various files within the directory
`bcgs-freesurfer`. Obviously, it is not generally a good idea to rename or move
directory `bcgs-freesurfer`, as doing so will break the symbolic links within
`bcgs-mne` that refer to files in the old `bcgs-freesurfer` directory. See:

	mv bcgs-freesurfer bcgs-new-freesurver
	somsds_broken_links bcgs-mne
	
The latter command will produce a long list of broken links, which may start like this:

	bcgs-mne/subjects/0001/bem/inner_skull.surf 
	--->>>/bcgs-freesurfer/subjects/0001/bem/watershed/0001_inner_skull_surface
	
	bcgs-mne/subjects/0001/bem/outer_skin.surf 
	--->>>bcgs-freesurfer/subjects/0001/bem/watershed/0001_outer_skin_surface

Fortunately, these broken links can be easily fixed with the utility 
script `somsds_fix_broken_links`:

	somsds_fix_links bcgs-mne --old bcgs-freesurfer --new bcgs-new-freesurfer
	
where the last two arguments are, respectively, the obsolete target directory 
name and the new target directory name. You can check now that there are no
broken links anymore:

	somsds_broken_links bcgs-mne
	
The command above should not output anything, meaning that all symbolic 
links are pointing to an existing target file. 

### Use somsds_copy_dir and somsds_move_dir

Most of the times, you can avoid completely breaking links by using
the utility scripts `somsds_copy_dir` and `somsds_move_dir` to copy or
move directory trees. These two scripts will automatically fix all the obviously
wrong symbolic links:

	somsds_copy_dir bcgs-freesurfer bcgs-new-freesurfer

After running the command above, there shouldn't be any broken links within
directory `bcgs-new-freesurfer`. However, it is always a good idea to check
that there are no remaining broken links:

	somsds_broken_links bcgs-new-freesurfer


## Link configuration files

__NOTE:__ This feature has not been throughfully tested.

This section is only of interest for advanced users that want to have full
control over the names of the symbolic links that are being generated by
script `somsds_link2rec`. By default, `somsds_link2rec` generates links
having names like:

	$RECID_$SUJID_$MODID_$DEVICEID_$TECID_$CONDID_$SESSION_$BLOCK<.ext>

and the `--orig` option forces those links to be located in folders named like:

	$RECNAME/subjects/$SUBJID/$MODID/raw	

For instance, the command:

	somsds_link2rec bcgs --modality smri --orig

generated, among others, the symbolic link:

	/data/projects/bcgs/recordings/bcgs/subjects/0002/smri/raw/bcgs_0002_smri_t1.nii

which pointed to this another symbolic link:

	/data/recordings/bcgs/subjects/0002/smri/raw/bcgs_0002_smri_t1.nii


which ultimately pointed to file:

	/data/recordings/bcgs/subjects/0002/smri/orig/ger001_WIP_c32_cap_T1_SENSE_FSL_16_1.nii

However, you might prefer to have a link called:

	/data/projects/bcgs/recordings/0002/0002-t1-smri.nii

instead of the default:

	/data/projects/bcgs/recordings/bcgs/subjects/0002/smri/raw/bcgs_0002_smri_t1.nii

That is, we want to get rid or change the order of some of the tags that appear
in the link name, change the location of the links and and we also want to
change the tag separator from an underscore to a hyphen. To achieve this
 behavior you will have to write a _link configuration file_ 
(`bcgs_link-conf.ini`) like the one shown below:

	# Link configuration file for project bcgs

	[link]
	# How are the full path names of the symbolic links constructed?
	name=SUBJID TECID MODID
	path=SUBJID
	field_sep       =_
	space_char      =-

And then you can run:

	somsds_link2rec bcgs --orig --conf bcgs_link-conf.ini



