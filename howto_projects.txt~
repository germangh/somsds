Perform analyses
============

[[Parent]]: user_documentation.txt

When analyzing data, the first thing that you need to do is to generate a 
_project_ directory where to store your scripts, documents, and intermediate
and final results. To illustrate the process, we will follow on the `bcgs` 
recording that we discussed in [Organizing your experimental data][recordings].

[recordings]: ./howto_recordings.htm


## Generate a project folder

To generate a _project_ directory containing a set of standard sub-folders run:

	somsds_new_project bcgs gherrero,yvdmeer,jramautar

The first argument to script `somsds_new_project` is the ID of your project. 
Since this project is going to involve the analysis of a single recording, it is 
reasonable to use the same ID for the project and the recording. The second
argument is a comma separate list of valid usernames. The first user in this 
list will be considered the responsible of the project and as such he or she 
will be the owner of the project directories. The other users in this list will
 all become members of a user group called `bcgs`, which will be granted write 
permission on the project folders. If more people become involved in the future
they should be manually added to the `bcgs` group.

Creating user groups and adding users to new groups can only be done by a
system administrator. This means that you __should ask an admin to generate your 
project directory tree__.

## Default directories

The default project directory tree consists of the following sub-directories:

	/data/projects/bcgs/tmp
	/data/projects/bcgs/doc
	/data/projects/bcgs/recordings
	/data/projects/bcgs/scripts
	/data/projects/bcgs/analysis
	/data/projects/bcgs/results/articles
	/data/projects/bcgs/results/posters
	/data/projects/bcgs/results/presentations	
	/data/projects/bcgs/results/software

### The `tmp` folder

The `tmp` folder should be used to store truly temporary data, i.e. after 
finalizing a project you should be able to empty the `tmp` folder without
 risking loosing any relevant data.

### The `doc` folder 

In the `doc` folder you should store all the documents required for understanding
your experimental protocol. The [recording settings file][settings_file] and
 all the relevant [name translation files][translation_file] should also be
 located here. 

[settings_file]: ./howto_settings_file.htm
[translation_file]: ./howto_file_descriptions.htm

### The `recordings` folder

The `recordings` folder will typically contain symbolic links to the data files
 that are being used by the project. Below we describe how this links can be
 generated. It might be a good idea to keep also in this recording single 
subject analyses and pre-processed files, but this is up to you. 

### The `scripts` folder

The `scripts` folder contains all the scripts necessary for reproducing all the
 analyses performed during the project. This folder should also contain a copy
 of all the toolboxes that were used in the project. This is important in order
 to ensure that the analyses can be reproduced in the future, even if the 
relevant toolboxes have changed due to continued development. 

### The `analysis` folder

The results and intermediate steps of your analysis should be stored in the
 `analysis` folder. 

### The `results` folder

The `results` folder should contain only publishable (well documented) outcomes
 of the project. This includes posters, papers, presentations and also any piece
 of software developed during the project and that might be publicly released.

## Link to recording data

### Link to /data/recordings/bcgs/subjects

The easiest way to work with your data is to simply create a symbolic link to 
`/data/recordings/bcgs/subjects`. This is done with the command:

	ln -s /data/recordings/bcgs/subjects 
		/data/projects/bcgs/recordings/svui/subjects --symbolic

Where the first input path to `ln -s` is the target path (the data you want to 
link to) and the second input path is the name that you want to give to your 
link. 

### Use somsds_link2rec

A more flexible alternative for generating symbolic links to the data relevant 
to the `bcgs` project is to go to the `/data/projects/bcgs/recordings` folder 
and run:

	somsds_link2rec bcgs --modalities eeg,smri
	
which will create links to all EEG and structural MRI data files of
recording `bcgs`. You can also specify a sub-set of subjects, techniques, etc 
using the correponding options `--subjects`, `--techniques`, etc. If you want to
link to all files from recording `bcgs`, you can run script `somsds_link2rec` 
without any option. The command above will create all the links in folder 
`/data/projects/bcgs/recordings/bcgs`:

	
	[gherrero@somerenserver recordings]$ ls bcgs
	bcgs_0001_eeg_in-noscan_1.mff  bcgs_0002_eeg_in-noscan_1.mff
	bcgs_0001_eeg_in-noscan_2.mff  bcgs_0002_eeg_in-noscan_2.mff
	bcgs_0001_eeg_in-noscan_3.mff  bcgs_0002_eeg_in-noscan_3.mff
	bcgs_0001_eeg_in-noscan_4.mff  bcgs_0002_eeg_in-noscan_4.mff
	bcgs_0001_eeg_in-scan_1.mff    bcgs_0002_eeg_in-scan_1.mff
	bcgs_0001_eeg_in-scan_2.mff    bcgs_0002_eeg_in-scan_2.mff
	bcgs_0001_eeg_in-scan_3.mff    bcgs_0002_eeg_in-scan_3.mff
	bcgs_0001_eeg_in-scan_4.mff    bcgs_0002_eeg_in-scan_4.mff
	bcgs_0001_eeg_out_1.mff        bcgs_0002_eeg_out_1.mff
	bcgs_0001_eeg_out_2.mff        bcgs_0002_eeg_out_2.mff
	bcgs_0001_eeg_out_3.mff        bcgs_0002_eeg_out_3.mff
	bcgs_0001_eeg_out_4.mff        bcgs_0002_eeg_out_4.mff
	bcgs_0001_smri_b1.nii          bcgs_0002_smri_b0.nii
	bcgs_0001_smri_sbrain.nii      bcgs_0002_smri_b1.nii
	bcgs_0001_smri_t1.nii          bcgs_0002_smri_t1.nii	

Now you can use the symbolic links above to perform any analysis that you may
think of. In most aspects these symbolic links can be understood as
nicely renamed copies of the original data files.

You may prefer the links to be organized in the same way as in 
`/data/recordings/bcgs`, instead of having them all under the same folder. 
For that you can use the flag `--orig`:

	somsds_link2rec bcgs --modalities eeg,smri --orig

which will create the folder structure:

	/data/projects/bcgs/recordings/bcgs/subjects/0001/eeg/raw/*.mff
 	/data/projects/bcgs/recordings/bcgs/subjects/0001/smri/raw/*.nii
	/data/projects/bcgs/recordings/bcgs/subjects/0001/eeg/raw/*.mff
 	/data/projects/bcgs/recordings/bcgs/subjects/0001/smri/raw/*.nii

The organization above is especially handy if you are planning to use software 
packages that use a similar folder structure (e.g. [FreeSurfer][freesurfer] or
the [MNE software][mne]). 

[freesurfer]: http://surfer.nmr.mgh.harvard.edu/
[mne]: http://www.nmr.mgh.harvard.edu/martinos/userInfo/data/sofMNE.php



## Pre-processing scripts

One of the great advantages of using a consistent organization of data files is 
that we can easily re-use analysis scripts. Below we show a couple of examples:

### Freesurfer

Imagine we would like to perform a [FreeSurfer][freesurfer] analysis on the 
two subjects of recording `bcgs`. You could do that by going to folder 
`/data/projects/bcgs/recordings` and running:

	somsds_link2rec bcgs --modality smri --orig
	smri_freesurfer bcgs

The simple script `smri_freesurfer` can save you some time if you have many
 subjects. Moreover, it will try to use the [Oracle Grid Engine][oge] that is 
installed in the server to run your jobs in parallel and without disturbing 
too much the work of others. 

[oge]: http://www.oracle.com/us/products/tools/oracle-grid-engine-075549.html

__NOTE:__ Script `smri_freesurfer` is not yet publicly available in the server. 


### MNE

If you aim to use the [MNE software][mne] to reconstruct the brain sources 
underlying your EEG or MEG data, you will have to perform a series of 
pre-processing steps, as described in the documentation of the MNE software. 
All these steps can now be simply performed with the commands:

	somsds_link2rec bcgs --modality smri --orig
	smri_mne bcgs

Again, `mne_bcgs` will use [Oracle Grid Engine][oge] to run these steps in 
parallel and without overloading the server. 


__NOTE:__ Script `smri_mne` is not yet publicly available in the server. 



## Link configuration files

__NOTE:__ This feature has not been throughfully tested yet

This section is only of interest for power users that want to have full control
over the names of the symbolic links that are being generated by script 
`somsds_link2rec`. By default, `somsds_link2rec` generates links having names 
like:

	$RECID_$SUJID_$MODID_$DEVICEID_$TECID_$CONDID_$SESSION_$BLOCK<.ext>

and the `--orig` option forces those links to be located in folders named like:

	$RECNAME/subjects/$SUBJID/$MODID/raw	

For instance, the command:

	somsds_link2rec bcgs --modality smri --orig

generated, among others, the symbolic link:

	/data/projects/bcgs/recordings/bcgs/subjects/0002/smri/raw/bcgs_0002_smri_t1.nii

which pointed to this another symbolic link:

	/data/recordings/bcgs/subjects/0002/smri/raw/bcgs_0002_smri_t1.nii


which ultimately pointed to file:

	/data/recordings/bcgs/subjects/0002/smri/orig/ger001_WIP_c32_cap_T1_SENSE_FSL_16_1.nii

However, you might prefer to have a link called:

	/data/projects/bcgs/recordings/0002/0002-t1-smri.nii

instead of the default:

	/data/projects/bcgs/recordings/bcgs/subjects/0002/smri/raw/bcgs_0002_smri_t1.nii

That is, we want to get rid or change the order of some of the tags that appear
in the link name, change the location of the links and and we also want to
change the tag separator from an underscore to a hyphen. To achieve this
 behavior you will have to write a _link configuration file_ 
(`bcgs_link-conf.ini`) like the one shown below:

	# Link configuration file for project bcgs

	[link]
	# How are the full path names of the symbolic links constructed?
	name=SUBJID TECID MODID
	path=SUBJID
	field_sep       =_
	space_char      =-

And then you can run:

	somsds_link2rec bcgs --orig --conf bcgs_link-conf.ini



